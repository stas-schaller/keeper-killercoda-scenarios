# Step 3: Creating & Updating Records, Files, and Password Generation

This step covers how to programmatically create and update records with different field types, manage file attachments (upload, download, delete), and generate strong passwords using the KSM Go SDK.

## 1. Prepare Your Environment

-   Ensure a working `ksm-config.json` from previous steps (or a One-Time Token for the first run).
-   Have the UID of a Shared Folder where your KSM application has **"Can Edit"** permissions. New records will be created here.
-   Create a sample file in your project directory for upload, e.g., `go-sample-upload.txt`.

```bash
echo "This is a Go SDK test file for upload purposes." > go-sample-upload.txt
ls -l go-sample-upload.txt
```
`echo "This is a Go SDK test file for upload purposes." > go-sample-upload.txt && ls -l go-sample-upload.txt`{{execute}}

## 2. Create Go Application: `manage_records_files.go`

In your `ksm-go-tutorial` project directory, create a new Go file.

```bash
touch manage_records_files.go
```
`touch manage_records_files.go`{{execute}}

### Add the Go Code

Paste the following code into `manage_records_files.go`. This program demonstrates creating records, password generation, file operations (upload, download, delete), and record updates.

```go
package main

import (
	"fmt"
	"io/ioutil"
	"log"
	"os"
	"path/filepath"

	ksm "github.com/keeper-security/secrets-manager-go/core"
	"github.com/keeper-security/secrets-manager-go/core/fields"
)

const oneTimeTokenStep3 = "[ONE_TIME_TOKEN_IF_NEEDED]"
const configFileStep3 = "ksm-config.json"

// ‚ö†Ô∏è Replace with UID of a Shared Folder with "Can Edit" permissions for your KSM App
const targetSharedFolderUid = "[YOUR_SHARED_FOLDER_UID_HERE]"
const fileToUploadName = "go-sample-upload.txt"
const downloadedFileName = "downloaded-go-sample.txt"

func main() {
	fmt.Println("üöÄ Creating/updating records, managing files, generating passwords with Go SDK...")

	storage := ksm.NewFileKeyValueStorage(configFileStep3)
	options := &ksm.ClientOptions{
		Config: storage,
	}
	if _, err := os.Stat(configFileStep3); os.IsNotExist(err) && oneTimeTokenStep3 != "[ONE_TIME_TOKEN_IF_NEEDED]" {
		fmt.Println("üîë Initial KSM storage setup with token...")
		options.Token = oneTimeTokenStep3
	}
	sm := ksm.NewSecretsManager(options)

	// --- 1. Create a New Login Record with Generated Password ---
	fmt.Println("\n--- Creating New Login Record with Generated Password ---")

	newLoginRecordData := ksm.NewRecordCreate("login", "Go SDK Secure Login")
	newLoginRecordData.Notes = "Created via Go SDK. Password generated by SDK."

	// Generate Password using GeneratePasswordWithOptions
	// Example: length 20, 5 uppercase, 5 lowercase, 5 digits, 5 special characters
	passwordOptions := &ksm.PasswordGenerationOptions{
		Length:          20,
		NumUppercase:    5,
		NumLowercase:    5,
		NumDigits:       5,
		NumSpecialChars: 5,
	}
	generatedPassword, err := ksm.GeneratePasswordWithOptions(passwordOptions)
	if err != nil {
		log.Fatalf("‚ùå Error generating password: %v", err)
	}
	fmt.Printf("üîí Generated Password: %s\n", generatedPassword)

	newLoginRecordData.Fields = append(newLoginRecordData.Fields, fields.NewLogin("securegopher@example.com"))
	newLoginRecordData.Fields = append(newLoginRecordData.Fields, fields.NewPassword(generatedPassword))
	newLoginRecordData.Fields = append(newLoginRecordData.Fields, fields.NewUrl("https://secure.golang.example.com"))

	newLoginRecordUid, err := sm.CreateSecretWithRecordData("", targetSharedFolderUid, newLoginRecordData)
	if err != nil {
		log.Fatalf("‚ùå Error creating login record: %v", err)
	}
	fmt.Printf("‚úÖ Login Record created successfully! UID: %s, Title: %s\n", newLoginRecordUid, newLoginRecordData.Title)

	// --- 2. Upload a File to the Newly Created Login Record ---
	var ownerRecord *ksm.KeeperRecord
	fmt.Println("\n--- Uploading File to New Login Record ---")
	fileBytes, err := ioutil.ReadFile(fileToUploadName)
	if err != nil {
		log.Printf("‚ùå Error reading file %s for upload: %v. Skipping upload.\n", fileToUploadName, err)
	} else {
		recs, errFetch := sm.GetSecrets([]string{newLoginRecordUid})
		if errFetch != nil || len(recs) == 0 {
			log.Fatalf("‚ùå Error fetching newly created record %s for file upload: %v", newLoginRecordUid, errFetch)
		}
		ownerRecord = recs[0]

		fileUpload := &ksm.KeeperFileUpload{
			Name:  fileToUploadName,
			Title: "Go SDK Uploaded Config - " + filepath.Base(fileToUploadName),
			Data:  fileBytes,
		}
		fmt.Printf("üìé Uploading '%s' to record UID: %s\n", fileUpload.Name, ownerRecord.Uid())
		uploadedFileUid, errUpload := sm.UploadFile(ownerRecord, fileUpload)
		if errUpload != nil {
			log.Fatalf("‚ùå Error uploading file: %v", errUpload)
		}
		fmt.Printf("‚úÖ File '%s' uploaded successfully to record UID: %s. File UID: %s\n", fileUpload.Name, ownerRecord.Uid(), uploadedFileUid)
		// Re-fetch the record to get updated file list
		ownerRecord, _ = sm.GetSecretByUid(newLoginRecordUid)
	}

	// --- 3. Download the Uploaded File ---
	if ownerRecord != nil && len(ownerRecord.Files) > 0 {
		fmt.Println("\n--- Downloading File from Record ---")
		fileToDownload := ownerRecord.Files[0] // Assuming first file is the one we want
		fmt.Printf("üíæ Downloading file: %s (UID: %s) from record %s\n", fileToDownload.Name, fileToDownload.Uid, ownerRecord.Uid())
		
		// file.SaveFile() saves the file to the specified path
		err = fileToDownload.SaveFile(downloadedFileName)
		if err != nil {
			log.Printf("‚ùå Error downloading file %s: %v\n", fileToDownload.Name, err)
		} else {
			fmt.Printf("‚úÖ File '%s' downloaded successfully to '%s'.\n", fileToDownload.Name, downloadedFileName)
			// You can verify content here if needed
			// downloadedBytes, _ := ioutil.ReadFile(downloadedFileName)
			// fmt.Printf("Downloaded content preview: %s\n", string(downloadedBytes[:20]))
		}
	}

	// --- 4. Delete the Uploaded File From Record ---
	if ownerRecord != nil && len(ownerRecord.Files) > 0 {
		fileToDeleteUid := ownerRecord.Files[0].Uid
		fmt.Printf("\n--- Deleting File (UID: %s) from Record %s ---\n", fileToDeleteUid, ownerRecord.Uid())

		// To delete a file, modify the record's fileRef field(s) and update the record.
		// Find the fileRef field if it exists, or create one if you are managing UIDs directly.
		// Simpler: SDK's DeleteFile function (if available and directly takes file UID)
		// Since Go SDK doesn't have a direct DeleteFile(fileUid) on SecretsManager,
		// we modify the ownerRecord.Files slice and then Save the record.
		// This approach is conceptual; the SDK might internally manage fileRefs.
		// A more robust way: find the fileRef field (type "fileRef") and remove the UID.
		// For this example, let's assume a direct SDK file deletion method or simplify.
		// Correct way for Go SDK: The SDK manages the fileRef field implicitly during file upload/delete.
		// The `DeleteFiles` method on `SecretsManager` should be used.
		err = sm.DeleteFiles(ownerRecord, []string{fileToDeleteUid})
		if err != nil {
			log.Printf("‚ùå Error deleting file %s from record %s: %v\n", fileToDeleteUid, ownerRecord.Uid(), err)
		} else {
			fmt.Printf("‚úÖ File %s deleted successfully from record %s.\n", fileToDeleteUid, ownerRecord.Uid())
			// Verify by fetching record again
			updatedRecordAfterFileDelete, _ := sm.GetSecretByUid(newLoginRecordUid)
			if updatedRecordAfterFileDelete != nil {
				fmt.Printf("    Files count on record after deletion: %d\n", len(updatedRecordAfterFileDelete.Files))
			}
		}
	}

	// --- 5. Update the Record's Notes ---
	if ownerRecord != nil {
		fmt.Println("\n--- Updating Record Notes ---")
		newNotes := ownerRecord.Notes() + "\nUpdated by Go SDK file management test at " + fmt.Sprint(ksm.CurrentTimeMillis())
		ownerRecord.SetNotes(newNotes)

		// To update standard or custom fields:
		// 1. Get the field using record.FieldByLabelOrType, record.CustomFieldByLabelOrType
		// 2. Modify its value(s) using field.SetValue(newValue)
		// 3. Call sm.Save(record)
		
		// Example: Update a custom field if it exists, or add it
		statusField := ownerRecord.CustomFieldByLabelOrType("SDK_Status", "text")
		if statusField != nil {
			statusField.SetValue("File Ops Complete")
		} else {
			newStatusField := fields.NewText("File Ops Complete")
			newStatusField.Label = "SDK_Status"
			ownerRecord.Record.Custom = append(ownerRecord.Record.Custom, newStatusField)
		}

		err = sm.Save(ownerRecord) // Save the modified record object
		if err != nil {
			log.Fatalf("‚ùå Error updating record notes/fields: %v", err)
		}
		fmt.Printf("‚úÖ Record %s notes/fields updated successfully.\n", ownerRecord.Uid())
	}

	fmt.Println("\nüéâ Record creation, update, file operations, and password generation examples complete. Check your Keeper Vault!")
}

```{{copy}}

## 3. Configure Shared Folder UID

-   In `manage_records_files.go`:
    -   **Crucial**: Replace `[YOUR_SHARED_FOLDER_UID_HERE]` with the UID of a Shared Folder in your Keeper Vault where your KSM application has **"Can Edit"** permissions.
    -   If needed (i.e., `ksm-config.json` doesn't exist from previous steps), update `[ONE_TIME_TOKEN_IF_NEEDED]`.

## 4. Update `main.go` to Run This Example (Optional)

Copy the content of `manage_records_files.go` into `main.go`, or build and run this specific file:

```bash
go build manage_records_files.go
./manage_records_files
```

## 5. Run the Application

Assuming you've updated `main.go` or are running `manage_records_files` directly:

```bash
go run main.go
# OR if you built it: ./manage_records_files
```
`go run main.go`{{execute}}

### Expected Output (will vary based on success of each operation):

```
üöÄ Creating/updating records, managing files, generating passwords with Go SDK...

--- Creating New Login Record with Generated Password ---
üîí Generated Password: <A_STRONG_GENERATED_PASSWORD>
‚úÖ Login Record created successfully! UID: ..., Title: Go SDK Secure Login

--- Uploading File to New Login Record ---
üìé Uploading 'go-sample-upload.txt' to record UID: ...
‚úÖ File 'go-sample-upload.txt' uploaded successfully to record UID: .... File UID: ...

--- Downloading File from Record ---
üíæ Downloading file: go-sample-upload.txt (UID: ...) from record ...
‚úÖ File 'go-sample-upload.txt' downloaded successfully to 'downloaded-go-sample.txt'.

--- Deleting File (UID: ...) from Record ... ---
‚úÖ File ... deleted successfully from record ...
    Files count on record after deletion: 0

--- Updating Record Notes ---
‚úÖ Record ... notes/fields updated successfully.

üéâ Record creation, update, file operations, and password generation examples complete. Check your Keeper Vault!
```

**Verify**: Check your Keeper Vault. A new record titled "Go SDK Secure Login" should be in your target shared folder. It should have had a file attached, then downloaded, then the file removed, and its notes/custom field updated.

## Understanding the Code

-   **`ksm.GeneratePasswordWithOptions()`**: Generates a strong, configurable password.
-   **Record Creation/Update (`ksm.NewRecordCreate`, `sm.CreateSecretWithRecordData`, `sm.Save`)**: Similar to previous examples, but now showing field updates before `sm.Save()`.
-   **File Upload (`sm.UploadFile`)**: Attaches a file to a `*ksm.KeeperRecord`.
-   **File Download (`file.SaveFile()`)**: The `KeeperFile` type (from `record.Files`) has a `SaveFile(destinationPath string)` method.
-   **File Deletion (`sm.DeleteFiles`)**: Deletes specified files from a given record. The SDK handles updating the record's internal file references.
-   **Field Updates**: To update existing fields on a fetched `*ksm.KeeperRecord`:
    1.  Access the field (e.g., `ownerRecord.CustomFieldByLabelOrType("SDK_Status", "text")`).
    2.  Use its `SetValue()` method (e.g., `statusField.SetValue("New Value")`).
    3.  For notes, use `record.SetNotes("new notes text")`.
    4.  Call `sm.Save(ownerRecord)` to persist the changes.

## Next Steps

In the final step, we'll cover folder management (create, list, update, delete folders) and demonstrate record deletion.


```golang

package main

// Import Secrets Manager
import ksm "github.com/keeper-security/secrets-manager-go/core"

func main() {

    configStrBase64 := `[KSM CONFIG IN BASE64]`

    config := ksm.NewMemoryKeyValueStorage(configStrBase64)   // Credentials in Base64 or Json
    sm := ksm.NewSecretsManagerFromConfig(config)
    
    allRecords, _ := sm.GetSecrets([]string{})          // Retrieve all records from Secrets Manager

    title := allRecords[0].Title()                  // Get title from the first record

    print("My Title of the record: ", title, "\n")  
}

```
## Run application

`go run ksm-example-initconf.go`{{execute}}
