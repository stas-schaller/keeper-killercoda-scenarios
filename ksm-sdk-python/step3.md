# Step 3: Creating Records with Password Generation

This step focuses on programmatically creating new records using the KSM Python SDK, including how to generate strong, random passwords for your new login records.

## Programmatic Record Creation Benefits

- **Automated secret provisioning** in CI/CD pipelines.
- **Dynamic credential generation** for applications or temporary access.
- **Bulk secret imports** or migrations.

## Understanding Record Types

Keeper supports various record types:
- **login**: Username/password combinations
- **bankCard**: Credit card information
- **contact**: Personal contact details
- **address**: Physical addresses
- **And many more...**

### 1. Create the Record Creation Script

If you are following sequentially, you might want to create a new file for this example, or update `main.py`.

```bash
# You can reuse main.py or create a new one like main_create_generated_pw.py
touch main.py 
```
`touch main.py`{{execute}}

### 2. Add the Record Creation Code with Password Generation

Copy and paste this code into your Python script (e.g., `main.py`):

```python
import os
from keeper_secrets_manager_core import SecretsManager
from keeper_secrets_manager_core.dto.dtos import RecordCreate, RecordField
from keeper_secrets_manager_core.storage import FileKeyValueStorage
from keeper_secrets_manager_core.utils import generate_password # Import the password generation utility

# Initialize the Secrets Manager using a config file (ensure it exists from Step 1 or provide a token)
# For simplicity, this example assumes ksm-config.json might exist. 
# If not, provide a ONE_TIME_TOKEN for initial setup.
ONE_TIME_TOKEN_CREATE = os.environ.get("KSM_ONE_TIME_TOKEN_CREATE", "[ONE_TIME_TOKEN_IF_NEEDED]")
CONFIG_FILE_NAME = "ksm-config.json" # Should be the same as in Step 1 if continuing

# Replace with the UID of a shared folder where your KSM App has edit permissions
TARGET_FOLDER_UID = os.environ.get("KSM_TARGET_FOLDER_UID", "[YOUR_TARGET_FOLDER_UID_HERE]")

secrets_manager = SecretsManager(
    token=ONE_TIME_TOKEN_CREATE if not os.path.exists(CONFIG_FILE_NAME) and ONE_TIME_TOKEN_CREATE != "[ONE_TIME_TOKEN_IF_NEEDED]" else None,
    config=FileKeyValueStorage(CONFIG_FILE_NAME)
)

# --- Create a new login record with a generated password ---
print("üîê Creating a new login record with a generated password...")

# Generate a strong password (e.g., 20 characters long)
# The generate_password() function can take length, and flags for lowercase, uppercase, digits, special chars.
# By default, it creates a strong password with a mix of character types.
# For more specific requirements, check SDK docs or use: utils.PasswordGenerationOptions
new_password = generate_password(length=20) 
print(f"üîë Generated Password: {new_password}")

new_login_record = RecordCreate(
    record_type='login', 
    title="KSM Python SDK - AutoGen Password Login"
)

new_login_record.fields = [
    RecordField(field_type='login', value='sdk.user.gen@example.com'),
    RecordField(field_type='password', value=new_password), # Use the generated password
    RecordField(field_type='url', value='https://sdk-app.example.com')
]
new_login_record.notes = 'Created via KSM Python SDK Tutorial.\nPassword was generated by the SDK.'

# Add some custom fields (optional)
custom_fields_data = [
    RecordField(field_type='text', label='Environment', value='Development'),
    RecordField(field_type='secret', label='API Key', value=generate_password(length=32)) # Also generate a custom API key
]
new_login_record.fields.extend(custom_fields_data)

try:
    if not TARGET_FOLDER_UID or TARGET_FOLDER_UID == "[YOUR_TARGET_FOLDER_UID_HERE]":
        raise ValueError("TARGET_FOLDER_UID placeholder must be replaced with an actual Folder UID.")

    print(f"Creating record in folder UID: {TARGET_FOLDER_UID}")
    new_record_uid = secrets_manager.create_secret(TARGET_FOLDER_UID, new_login_record)
    
    print(f"\n‚úÖ Successfully created record!")
    print(f"üìã New Record UID: {new_record_uid}")
    print(f"üìù Title: {new_login_record.title}")
    print(f"üîë Type: {new_login_record.type}")
    print(f"üîí Password (generated): {new_password}") # For verification, normally not printed

except Exception as e:
    print(f"‚ùå Error creating record: {str(e)}")
    print("üí° Make sure you have:")
    print("   - A valid KSM configuration (ksm-config.json or a one-time token for initial setup).")
    print(f"   - Correct TARGET_FOLDER_UID ('{TARGET_FOLDER_UID}') with write permissions.")

### 3. Configure Required Parameters

-   **`[ONE_TIME_TOKEN_IF_NEEDED]`**: 
    -   If `ksm-config.json` (from Step 1) does **not** exist, replace this placeholder (or set `KSM_ONE_TIME_TOKEN_CREATE` env var) with a valid One-Time Access Token to initialize the configuration file.
    -   If `ksm-config.json` **already exists** and is valid, the token is not strictly needed for this script to run (you can leave the placeholder or set the env var to an empty string if the script handles `None` for token appropriately, as this example does).
-   **`[YOUR_TARGET_FOLDER_UID_HERE]`**: 
    -   **Crucial**: Replace this placeholder (or set `KSM_TARGET_FOLDER_UID` env var) with the UID of a Shared Folder in your Keeper Vault where your KSM Application has **"Can Edit"** permissions. New records will be created in this folder.
    -   To get a Folder UID: Log into Keeper Web Vault ‚Üí Navigate to the folder ‚Üí Right-click ‚Üí Get Info ‚Üí Copy Folder UID.

### 4. Run the Record Creation Script

```bash
python3 main.py # or your chosen filename
```
`python3 main.py`{{execute}}

## Understanding the Code

-   **`from keeper_secrets_manager_core.utils import generate_password`**: This line imports the password generation utility from the SDK.
-   **`new_password = generate_password(length=20)`**: 
    -   Calls the `generate_password()` function to create a strong, random password. 
    -   You can specify `length`, and boolean flags like `lowercase`, `uppercase`, `digits`, `special_chars` to customize the password policy. By default, it creates a mix. Refer to SDK documentation (or `pydoc keeper_secrets_manager_core.utils.generate_password`) for more options like `PasswordGenerationOptions`.
-   **`RecordCreate` and `RecordField`**: Used as before to define the new record's structure and content, but this time the `password` field uses the `new_password` variable.
-   **Custom Fields**: The example also shows adding custom fields, one of which also uses `generate_password()` for its value.

## Security Best Practices for Generated Passwords

-   **Use Sufficient Length and Complexity**: Ensure generated passwords meet your organization's security policies (e.g., minimum length, character type requirements).
-   **Do Not Log Generated Passwords**: The example prints the password for verification during the tutorial, but in a production application, never log sensitive generated credentials.

## Next Steps

In the next step, we'll learn how to attach files to records, download them, and manage these file attachments.
